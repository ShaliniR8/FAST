/*! jQuery imgNotes - v0.7.4 - 2014-11-01
* https://github.com/waynegm/imgNotes
* Copyright (c) 2014 Wayne Mogg; Licensed MIT */
(function(t){t.widget("wgm.imgNotes",{options:{zoom:1,zoomStep:.1,zoomable:!0,canEdit:!1,vAll:"middle",hAll:"middle",onAdd:function(){return this.options.vAll="bottom",this.options.hAll="middle",t(document.createElement("span")).addClass("marker black").html(this.noteCount)},onEdit:function(e,o){var i=t(o);return t("#NoteDialog").remove(),t('<div id="NoteDialog"></div>').dialog({title:"Note Editor",resizable:!1,modal:!0,height:"300",width:"450",position:{my:"left bottom",at:"right top",of:o},buttons:{Save:function(){var e=t("textarea",this).val();i.data("note",e),t(this).dialog("close")},Delete:function(){i.trigger("remove"),t(this).dialog("close")},Cancel:function(){t(this).dialog("close")}},open:function(){t(this).css("overflow","hidden");var e=t('<textarea id="txt" style="height:100%; width:100%;">');t(this).html(e),e.val(i.data("note"))}})},onShow:function(e,o){var i=t(o);return t("#NoteDialog").remove(),t('<div id="NoteDialog"></div>').dialog({modal:!1,resizable:!1,height:300,width:250,position:{my:"left bottom",at:"right top",of:o},buttons:{Close:function(){t(this).dialog("close")}},open:function(){t(this).html(i.data("note")),t(this).closest(".ui-dialog").find(".ui-dialog-titlebar:first").hide()},close:function(){t(this).dialog("destroy")}})},onUpdateMarker:function(e){var o=t(e),i=t(this.img),a=i.imgViewer("imgToView",o.data("relx"),o.data("rely"));a&&o.css({left:a.x-o.data("xOffset"),top:a.y-o.data("yOffset"),position:"absolute"})},onUpdate:function(){var e=this;t.each(this.notes,function(){e.options.onUpdateMarker.call(e,this)})}},_create:function(){var e=this;this.element.is("img")||t.error("imgNotes plugin can only be applied to img elements"),e.notes=[],e.noteCount=0,e.img=e.element[0];var o=t(e.img);o.imgViewer({onClick:function(t,o){if(e.options.canEdit){t.preventDefault();var i=o.cursorToImg(t.pageX,t.pageY);if(i){var a=e.addNote(i.x,i.y);e._trigger("onEdit",t,a)}}},onUpdate:function(t,o){e.options.zoom=o.options.zoom,e.options.onUpdate.call(e)},zoom:e.options.zoom,zoomStep:e.options.zoomStep,zoomable:e.options.zoomable}),o.imgViewer("update")},destroy:function(){this.clear(),t(this.img).imgViewer("destroy"),t.Widget.prototype.destroy.call(this)},_setOption:function(e,o){switch(e){case"vAll":switch(o){case"top":break;case"bottom":break;default:o="middle"}break;case"hAll":switch(o){case"left":break;case"right":break;default:o="middle"}}var i=t.ui.version.split(".");switch(i[0]>1||i[1]>8?this._super(e,o):t.Widget.prototype._setOption.apply(this,arguments),e){case"zoom":t(this.img).imgViewer("option","zoom",o);break;case"zoomStep":t(this.img).imgViewer("option","zoomStep",o);break;case"zoomable":t(this.img).imgViewer("option","zoomable",o)}},panTo:function(e,o){return t(this.img).imgViewer("panTo",e,o)},addNote:function(e,o,i){var a=this;this.noteCount++;var n=this.options.onAdd.call(this),s=t(n);switch(t(this.img).imgViewer("addElem",n),s.data("relx",e).data("rely",o).data("note",i),this.options.vAll){case"top":s.data("yOffset",0);break;case"bottom":s.data("yOffset",s.height());break;default:s.data("yOffset",Math.round(s.height()/2))}switch(this.options.hAll){case"left":s.data("xOffset",0);break;case"right":s.data("xOffset",s.width());break;default:s.data("xOffset",Math.round(s.width()/2))}return s.click(function(t){t.preventDefault(),a.options.canEdit?a._trigger("onEdit",t,n):a._trigger("onShow",t,n)}),s.on("remove",function(){a._delete(n)}),this.notes.push(n),n},count:function(){return this.noteCount},_delete:function(e){this.notes=this.notes.filter(function(t){return t!==e}),t(e).remove(),t(this.img).imgViewer("update")},clear:function(){var e=this;t.each(e.notes,function(){var e=t(this);e.remove()}),e.notes=[],e.noteCount=0},"import":function(e){var o=this;t.each(e,function(){o.addNote(this.x,this.y,this.note)}),t(this.img).imgViewer("update")},"export":function(){var e=[];return t.each(this.notes,function(){var o=t(this);e.push({x:o.data("relx"),y:o.data("rely"),note:o.data("note")})}),e}})})(jQuery);