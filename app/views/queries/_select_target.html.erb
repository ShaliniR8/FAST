<script type="text/javascript" src="/javascripts/utility/delete.js"></script>
<script type="text/javascript" src="/javascripts/utility/nested_fields.js"></script>
<script type="text/javascript" src="/javascripts/utility/collapse-panel2.js"></script>
<script type="text/javascript" src="/javascripts/utility/validate-form.js"></script>


<div class="panel panel-lightblue">
  <div class="panel-heading">
    <div class="panel-title">
      Step 1. <font style="font-weight:normal">Select a Target</font>
    </div>
  </div>
  <div class="panel-body">

    <table id="targets" class="table table-bordered table-hover table-striped">
      <thead>
        <tr>
          <th style="background:tan!important">Target Name</th>
        </tr>
      </thead>
      <tbody>
        <%@types.stringify_keys.each do |k, v|%>
          <tr><td data-target-name="<%=v%>"><%=k%></td></tr>
        <%end%>
      </tbody>
    </table>

    <div class="col-xs-12">
      <table id="templates" class="mt20 table table-bordered table-hover table-striped" style="display:none">
        <thead>
          <tr>
            <th style="background:tan!important">Select Templates</th>
          </tr>
        </thead>
        <tbody>
          <% if  session[:mode] == "SMS" %>
            <tr><td data-template-id="-1">NO TEMPLATE</td></tr>
            <%@checklists.stringify_keys.each do |k, v|%>
              <tr><td data-template-id="<%=v%>"><%=k%></td></tr>
            <%end%>
          <%else%>
            <%@templates.stringify_keys.each do |k, v|%>
              <tr><td data-template-id="<%=v%>"><%=k%></td></tr>
            <%end%>
          <%end%>
        </tbody>
      </table>
    </div>


  </div>
</div>


<style>
  .table-bordered {
    border: 2px solid tan !important;
  }
  .panel-lightsteelblue {
    border: 1px solid lightsteelblue;
  }
  .panel-lightsteelblue .panel-heading .panel-title {
    padding: 5px !important;
    min-height: 0px !important;
  }

</style>


<script>
  $(function(){

    <%if @owner.target.present?%>
      selectTarget($('td[data-target-name="<%=@owner.target%>"]'));
    <%end%>

    $("#targets tbody tr td").on("click", function(){selectTarget($(this));});
    $("#templates tbody tr td").on("click", function(){selectTemplates($(this));});
  });


  function selectTemplates(cell) {
    if($(cell).css("background-color") === "rgb(173, 216, 230)")
      $(cell).css("background-color", "transparent");
    else
      $(cell).css("background-color", "lightblue");

    var templates = getSelectedTemplates("templates");
    var target = getSelectedTarget("targets");
    var target_name = getSelectedTargetName("targets");

    $.ajax({
      url: "<%=load_conditions_block_queries_path%>",
      type: 'GET',
      data: {
        <%if @owner.id.present?%>
          "query_id": <%=@owner.id%>,
        <%end%>
        "target": target,
        "templates": templates,
        "target_display_name": target
      },
      beforeSend: function(){$('#step2_loader').show();$("#building_query").css({'opacity':0.5});},
      complete: function(){$('#step2_loader').hide();$("#building_query").css({'opacity':1});},
      success: function(response){$("#building_query").html(response);},
      error: function(response){console.log(response);}
    });
  }

  function selectTarget(cell) {

    $("#targets td").css("background-color", "transparent");
    $(cell).css("background-color", "lightblue");

    var target = $(cell).attr("data-target-name");
    var target_name = getSelectedTargetName("targets");

    $.ajax({
      url: "<%=load_conditions_block_queries_path%>",
      type: 'GET',
      data: {
        <%if @owner.id.present?%>
          "query_id": <%=@owner.id%>,
        <%end%>
        "target": target,
        "target_display_name": target_name
      },
      beforeSend: function(){$('#step2_loader').show();$("#building_query").css({'opacity':0.5});},
      complete: function(){$('#step2_loader').hide();$("#building_query").css({'opacity':1});},
      success: function(response){
        $("#building_query").html(response);
        <%if @owner.templates.present?%>
          <%@owner.templates.each do |template|%>
            $("td[data-template-id='" + <%=template%> + "']").css("background-color", "lightblue");
          <%end%>
          selectTemplates(null);
        <%end%>
      },
      error: function(response){console.log(response);}
    });

    if (target_name == "Submission" || target_name == "Report" || target_name == "Checklist") {
      $("#templates").show();
      $("#templates td").css("background-color", "transparent");
    } else {
      $("#templates").hide();
    }
  }


  function getSelectedTemplates(table) {
    var templates = [];
    $("#" + table + " td").each(function(){
      if ($(this).css("background-color") === "rgb(173, 216, 230)") {
        templates.push($(this).attr("data-template-id"));
      }
    });
    return templates;
  }

  function getSelectedTargetName(table) {
    var target;
    $("#" + table + " td").each(function(){
      if ($(this).css("background-color") === "rgb(173, 216, 230)") {
        target = $(this).html();
      }
    });
    return target;
  }

  function getSelectedTarget(table) {
    var target;
    $("#" + table + " td").each(function(){
      if ($(this).css("background-color") === "rgb(173, 216, 230)") {
        target = $(this).attr("data-target-name");
      }
    });
    return target;
  }



</script>
