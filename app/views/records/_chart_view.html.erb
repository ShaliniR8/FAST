<%field_name = @label.parameterize.underscore%>

<div class="row">
	<ul class="nav nav-tabs">
		<li class="active">
			<a class="nav-item nav-link active" 
				id="nav-grid-tab-<%=field_name%>" 
				data-toggle="tab" 
				href="#nav-grid-<%=field_name%>" 
				role="tab" 
				aria-controls="nav-grid-<%=field_name%>" 
				aria-selected="true">
				Grid View
			</a>
		</li>		
		<li>
			<a class="nav-item nav-link" 
				id="nav-chart-tab-<%=field_name%>" 
				data-toggle="tab" 
				href="#nav-piechart-<%=field_name%>" 
				role="tab" 
				aria-controls="nav-chart-<%=field_name%>" 
				aria-selected="false"> 
				Pie Chart
			</a>
		</li>
		<li>
			<a class="nav-item nav-link active" 
				id="nav-chart-tab-<%=field_name%>" 
				data-toggle="tab" 
				href="#nav-barchart-<%=field_name%>" 
				role="tab" 
				aria-controls="nav-chart-<%=field_name%>" 
				aria-selected="false">
				Bar Chart
			</a>
		</li>
	</ul>

	<div class="tab-content">
		<div class="tab-pane fade in show active" 
			id="nav-grid-<%=field_name%>" 
			role="tabpanel" 
			aria-labelledby="nav-grid-tab-<%=field_name%>">
			<%= render "/records/query_result/grid_view"%>
		</div>	
		<div class="tab-pane fade" 
			id="nav-piechart-<%=field_name%>" 
			role="tabpanel" 
			aria-labelledby="nav-piechart-tab-<%=field_name%>">
			<%= render "/records/query_result/piechart_view"%>
		</div>	
		<div class="tab-pane fade" 
			id="nav-barchart-<%=field_name%>" 
			role="tabpanel" 
			aria-labelledby="nav-barchart-tab-<%=field_name%>">
			<%= render "/records/query_result/barchart_view"%>
		</div>	


<!-- 		<div class="tab-pane fade" 
			id="nav-chart-<%=field_name%>" 
			role="tabpanel" 
			aria-labelledby="nav-chart-tab-<%=field_name%>">
			<div id="chart_div-<%=field_name%>" style="width:'100%'"></div>
			<div class="mr5" id="chart_download" align="right"></div> 
		</div> -->


	</div>
</div>



<script>
	google.charts.load("current", {packages:["corechart"]});
	google.charts.setOnLoadCallback(drawBarChart);
	google.charts.setOnLoadCallback(drawPieChart);
	var colorArray = colorInterpolation(<%=@data.length%>);
	


	function drawBarChart(){
		$("chart_div-<%=field_name%>").html("");
		var data = new google.visualization.DataTable();
		data.addColumn("string", "Value");
		data.addColumn("number", "Count");
		data.addColumn({type: "string", role: "tooltip"});
		data.addColumn({type: "string", role: "annotationText"});
		data.addColumn({type: "string", role: "style"});
		data.addRows([
			<%@data.each_with_index do |(k, v), index|%>
				[<%="'#{index+1}', #{v}, '#{k}', '#{k}',"%> colorArray[<%=index%>]],
			<%end%>
		]);
		var view = new google.visualization.DataView(data);
		view.setColumns([0, 1,
			{	calc: "stringify",
				sourceColumn: 1,
				type: "string",
				role: "annotation"
			}, 2, 3, 4]);
		var options = {
			height: 500,
			title: "Analytics of <%=raw(@label)%>",
			titleTextStyle: {color: "black", fontSize: 18, bold: true},
			legend: { position: 'none'},
			bar: {groupWidth: "90%"},
		};
		var barChart = new google.visualization.ColumnChart(document.getElementById('chart_div-<%=field_name%>'));
		google.visualization.events.addListener(barChart, 'onmouseover', uselessHandler2);
		google.visualization.events.addListener(barChart, 'onmouseout', uselessHandler3);
	
		google.visualization.events.addListener(barChart, 'ready', function () {
			document.getElementById('chart_download').innerHTML = '<a href="' + barChart.getImageURI() + '"download><u>Download Chart</u></a>';
		});
		barChart.draw(view, options);
	}



	function drawPieChart(){
		$("chart_div-<%=field_name%>").html("");
		var data = new google.visualization.DataTable();
		data.addColumn("string", "Value");
		data.addColumn("number", "Count");
		data.addColumn({type: "string", role: "tooltip"});
		data.addColumn({type: "string", role: "annotationText"});
		data.addColumn({type: "string", role: "style"});
		data.addRows([
			<%@data.each_with_index do |(k, v), index|%>
				[<%="'#{k}', #{v}, '#{k}', '#{k}',"%> colorArray[<%=index%>]],
			<%end%>]);

		var view = new google.visualization.DataView(data);
		view.setColumns([0, 1,
			{	calc: "stringify",
				sourceColumn: 1,
				type: "string",
				role: "annotation"
			}, 2, 3, 4]);
		var options = {
			height: 500,
			title: "Analytics of <%=@field.label%>",
			titleTextStyle: {color: "black", fontSize: 18, bold: true},
			legend: {position: 'labeled'},
			colors: colorArray,
			pieSliceTextStyle: { color: 'black'},
			pieSliceText: 'annotationText',
			chartArea: {  height: "40%", width: "95%" },
			tooltip: {textStyle: {color: 'black'}, showColorCode: true},
		};
		var pieChart = new google.visualization.PieChart(document.getElementById('chart_div-<%=field_name%>'));
		google.visualization.events.addListener(pieChart, 'onmouseover', uselessHandler2);
		google.visualization.events.addListener(pieChart, 'onmouseout', uselessHandler3);
	
		google.visualization.events.addListener(pieChart, 'ready', function () {
			document.getElementById('chart_download').innerHTML = '<a href="' + pieChart.getImageURI() + '"download><u>Download Chart</u></a>';
		});
		pieChart.draw(view, options);
	}



	function uselessHandler2() {
		$('#chart_div-<%=field_name%>').css('cursor','pointer');
	}  
	function uselessHandler3() {
		$('#chart_div-<%=field_name%>').css('cursor','default');
	} 



	$(window).bind('resizeEnd', function(){
		drawBarChart();
		drawPieChart();
	});

</script>






