<script type="text/javascript" src="/javascripts/utility/extra_fields.js"></script>
<%=form_for @record do |f|%>
  <div class="panel panel-warning">
    <div class="panel-heading">
      <div class="panel-title"><b><%=controller.action_name.titleize%> Distribution List</b>
        <button type="button" class="close pull-right" data-dismiss="modal" aria-label="Close">
          <span class="glyphicon glyphicon-remove"></span>
        </button>
      </div>
    </div>
    <div class="panel-body">
      <div class="row" style="max-height:1000px;overflow-y:auto;">
        <div class="col-xs-7">
          <%=render 'recipients'%>
        </div>
        <div class="col-xs-5">
          <%if action_name == "new"%>
            <%=f.hidden_field :created_by_id, :value => current_user.id%>
          <%end%>
          <div class="form-group col-xs-12">
            <%= f.label :title, "Title" %>
            <%= f.text_field :title, :class => "form-control ml5" %>
          </div>
          <div class="form-group col-xs-12">
            <%= f.label :to_list, "TO" %>
            <p class="ml5" style="overflow-y:auto;" id="to_list"></p>
          </div>
          <div class="form-group col-xs-12">
            <%= f.label :description, "Description" %>
            <%= f.text_area :description, :class => "form-control ml5", :rows => "5" %>
          </div>
        </div>
        <div class="col-xs-12">
          <%=f.submit "Save",:class=>"btn btn-success pull-right mt5 mr15", disable_with: "Saving..."%>
          <%if controller.action_name == "edit"%>
            <%= link_to "Delete", distribution_list_path(@record), :method=>"delete", :confirm=>'Please confirm that you want to delete this distribution list. The deletion cannot be reverted',:class=>"btn btn-danger pull-right mt5 mr5"%>
          <%end%>
        </div>
      </div>
    </div>
  </div>
<%end%>

<script type="text/javascript">
  $(function() {
    recipients_table = $('#recipients').DataTable();

    $(document).ready(function() {
      renderRecipients(recipients_table);

      $("#recipients").on('click','.send_btn',function() {
        $(this).toggleClass('enabled');
        if ($(this).hasClass('enabled')) {
          $(this).text('Added');
        } else {
          $(this).text('Add');
        }
        renderRecipients(recipients_table);
      });

      var allPages = recipients_table.cells().nodes();
      $(".clear_btn").on('click',function() {
        $(allPages).find('.send_btn').each(function(data) {
          if ($(this).hasClass('btn-danger')) {
            $(this).removeClass('btn-danger').addClass('btn-transparent');
            $(this).removeClass('enabled').text('Add');
          }
        });
        renderRecipients(recipients_table);
      });
    });
  });

  function renderRecipients(recipients_table) {
    var to_user_ids = [];
    var cc_user_ids = [];
    recipients_table.rows().nodes().to$().each(function() {
      if ($(this).find('.send_btn').hasClass('btn-danger')) {
        to_user_ids.push($(this).attr('name'));
      }
      if ($(this).find('.cc_btn').hasClass('btn-danger')) {
        cc_user_ids.push($(this).attr('name'));
      }
    })
    document.getElementById("to_list").innerHTML = to_user_ids.sort().join(', ');
  }
</script>
