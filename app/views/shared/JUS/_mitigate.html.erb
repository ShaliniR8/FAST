<div class="panel panel-warning">

  <div class="panel-heading">
    <div class="panel-title">
      <b>Mitigated Risk Assessment</b><button type="button" class="close pull-right" data-dismiss="modal" aria-label="Close"><span class="glyphicon glyphicon-remove"></span></button>
    </div>
  </div>

  <div class="panel-body" style="max-height:600px;overflow-y:auto;">
    <%=form_for @owner do |f|%>

      <%=f.hidden_field :severity_after,:value=>"",:id=>"sev"%>
      <%=f.hidden_field :likelihood_after,:value=>"",:id=>"like"%>
      <%=f.hidden_field :risk_factor_after, :value => "", :id => "risk_fact"%>

      <div class="row">
        <%=render "/shared/JUS/mitigate_content", :f => f%>
        <div class="col-xs-12">
          <%=f.submit "Submit",:class=>"btn btn-success pull-right mr5", disable_with: "Submitting..."%>
        </div>
      </div>
    <%end%>
  </div>
</div>


<style>
  .table-cursor td:hover {
    opacity: 0.8;
    cursor: pointer;
    background-color: #F0F8FF;
  }
  .table-centered th{
    font-size: 16px;
  }
  .table-fixed { table-layout: fixed; }
</style>

<script>
  function load_mitigate_data(){
    <%if @target.get_mitigated_severity.present? && @target.get_mitigated_probability.present?%>
      $('.mitigate_severity_td').each(function(){
        <%(0..@severity_table[:row_header].size-1).each do |i|%>
          if ($(this).data('row')==<%=i%>){
            if($(this).data('column')==<%=@target.get_mitigated_severity[i]%>){
              $(this).data("status","checked");
              $(this).css('background','#FCAFCB');
            }
          }
        <%end%>
      });
      $('.mitigate_probability_td').each(function(){
        <%(0..@probability_table[:row_header].size-1).each do |i|%>

          if ($(this).data('row')==<%=i%>){
            if($(this).data('column')==<%=@target.get_mitigated_probability[i]%>){
              $(this).data("status","checked");
              $(this).css('background','#FCAFCB');
            }
          }
        <%end%>
      });
      calculate_mitigate();
    <%end%>
  }

  function initiliaze_mitigate(){
    $('.mitigate_severity_td').on('click',function(){
      if ($(this).data("status")==="checked"){
        $(this).data("status","");
        $(this).css('background','none');
      }else{
        $(this).data("status","checked");
        $(this).css('background','#FCAFCB');
        row_id=$(this).data("row");
        column_id=$(this).data("column");
        $('.mitigate_severity_td').each(function(){
          if ($(this).data("row") == row_id &&  $(this).data("column") != column_id){
            $(this).data("status","");
            $(this).css('background','none');
          }
        });
      }
      calculate_mitigate();
    });
    $('.mitigate_probability_td').on('click',function(){
      if ($(this).data("status")==="checked"){
        $(this).data("status","");
        $(this).css('background','none');
      }else{
        $(this).data("status","checked");
        $(this).css('background','#FCAFCB');
        row_id=$(this).data("row");
        column_id=$(this).data("column");
        $('.mitigate_probability_td').each(function(){
          if ($(this).data("row") == row_id &&  $(this).data("column") != column_id){
            $(this).data("status","");
            $(this).css('background','none');
          }
        });
      }
      calculate_mitigate();
    });
  }

  function calculate_mitigate(){
    severities = []
    probabilities = []
    severity_checked = 0
    probability_checked = 0
    $('.mitigate_severity_td').each(function(){
      if ($(this).data("status") === "checked"){
        severities.push($(this).data("column"));
        severity_checked++;
      }
    });
    $('.mitigate_probability_td').each(function(){
      if ($(this).data("status") === "checked"){
        probabilities.push($(this).data("column"));
        probability_checked++;
      }
    });
    if (probability_checked>0 && severity_checked>0){
      mitigate(Math.min(...probabilities),Math.min(...severities));
    }else{
      clear_mitigate();
    }
  }

  function clear_mitigate(){
    $('.mitigate_risk_td').each(function(){
        $(this).text("");
    });
  }

  // function mitigate(row_index,column_index){
  //   if (column_index > 4.00){
  //     column_index = 0;
  //   }else if (column_index > 2.5)   {
  //     column_index = 1;
  //   }else if (column_index > 1){
  //     column_index = 2;
  //   }else{
  //     column_index = 3;
  //   }

  //   if (row_index > 4.00){
  //     row_index = 0;
  //   }else if (row_index > 3.00){
  //       row_index = 1;
  //   }else if (row_index > 2.00){
  //     row_index = 2;
  //   }else if (row_index > 1.00){
  //     row_index = 3;
  //   }else{
  //     row_index = 4;
  //   }
  //   clear_mitigate();
  //   $('.mitigate_risk_td').each(function(){
  //     risk_table_def = <%=JUS_Config::MATRIX_INFO[:risk_table][:rows].to_json.html_safe%>
  //     risk_table_indx = <%=JUS_Config::MATRIX_INFO[:risk_table_index].to_json.html_safe%>
  //     if($(this).data("row")==row_index && $(this).data("column")==column_index){
  //       $(this).html("<span class='glyphicon glyphicon-ok style='color:black'></span>");
  //       $('#sev').val(row_index);
  //       $('#like').val(column_index);
  //       $('#risk_fact').val(risk_table_indx[risk_table_def[row_index][column_index]]);      
  //     }
  //   });
  // }

  function mitigate(row_index,column_index){
    clear_mitigate();
    $('.mitigate_risk_td').each(function(){
      risk_table_def = <%=JUS_Config::MATRIX_INFO[:risk_table][:rows].to_json.html_safe%>
      risk_table_indx = <%=JUS_Config::MATRIX_INFO[:risk_table_index].to_json.html_safe%>
      if($(this).data("row")==row_index && $(this).data("column")==column_index){
        $(this).html("<span class='glyphicon glyphicon-ok style='color:black'></span>");
        $('#sev').val(row_index);
        $('#like').val(column_index);
        $('#risk_fact').val(risk_table_indx[risk_table_def[row_index][column_index]]);      
      }
    });
  }

  $(document).ready(function(){
    load_mitigate_data();
    initiliaze_mitigate();
    $('form').on('submit',function(){
      var severity_result = new Array(<%= @severity_table[:row_header].size %>);
      var probability_result = new Array(<%= @probability_table[:row_header].size %>);
      $('.mitigate_severity_td').each(function(){
        if ($(this).data('status')==="checked"){
          severity_result[$(this).data("row")] = $(this).data("column");
        }
      });
      $('.mitigate_probability_td').each(function(){
        if ($(this).data('status')==="checked"){
          probability_result[$(this).data("row")] = $(this).data("column");
        }
      });
      for (i = 0; i < severity_result.length; i++){
        $('form').append("<input name='<%=@target_name%>[<%=@severity_field%>][]' value="+severity_result[i]+" hidden></input>");
      }
      for (i = 0; i < probability_result.length; i++){
        $('form').append("<input name='<%=@target_name%>[<%=@probability_field%>][]' value="+probability_result[i]+" hidden></input>");
      }
      return true;
    });
  });
</script>
