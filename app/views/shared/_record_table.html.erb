<%= stylesheet_link_tag "/plugins/tables/datatables-1.10.16/datatables.min.css" %>
<%= javascript_include_tag "/plugins/tables/datatables-1.10.16/datatables.min.js" %>
<script type="text/javascript" src="//cdn.datatables.net/plug-ins/1.10.16/sorting/natural.js"></script>
<script type="text/javascript" src="/javascripts/utility/format-builder.js"></script>


<div class="col-xs-12">
  <%= render "shared/alerts" %>
  <%= render "access_controls/new_modal"%>
  <%if defined?(panel)%>
    <div class="panel panel-<%=panel%>">
  <%else%>
    <div class="panel panel-info">
  <%end%>
    <div class="panel-heading">
      <div class="panel-title">
        <div class="top_text">
          <b><%=@title%></b>
        </div>
        <div class="top_buttons pull-right">
          <%if defined?(btn_name)%>
            <%=link_to btn_name,
                       btn_path,
                       :class => "btn btn-success",
                       :disable_with => "Redirecting..."%>
          <%end%>
        </div>
      </div>
    </div>

    <div class="panel-body">
      <div class="table-responsive">
        <table id="records_table" class="table table-hover table-striped table-bordered" width="100%">
          <thead>
            <tr>
              <%@headers.each do |header|%>
                <th class="<%=header[:size]%>">
                  <%=header[:title]%>
                </th>
              <%end%>
            </tr>
          </thead>
          <tfoot>
            <tr>
              <%@headers.each do |header|%>
                <th class="<%=header[:size]%>">
                  <%=header[:title]%>
                </th>
              <%end%>
            </tr>
          </tfoot>
          <tbody>
            <%@records.each do |record|%>
              <tr record_id="<%=record.id%>">
                <%@headers.each do |header|%>
                  <%if header[:param].present?%>
                    <td class="<%=header[:html_class].present? ? record.send(header[:html_class]) : ''%>">
                      <%=record.send(header[:field],header[:param])%>
                    </td>
                  <%else%>
                    <td class="<%=header[:html_class].present? ? record.send(header[:html_class]) : ''%>">
                      <%=render "forms/show_field", :field_hash => header, :record => record%>
                    </td>
                  <%end%>
                <%end%>
              </tr>
            <%end%>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<style>
 .datepicker{
  z-index: 1200!important;
 }
  tfoot {
    display: table-header-group;
  }
  .table tbody tr > td.red {
    background-color: orange !important;
  }
  .table tbody tr > td.yellow {
    background-color: yellow !important;
  }
  .table tbody tr > td.green {
    background-color: mediumseagreen !important;
  }

</style>


<script>

  $('#records_table tbody tr').on('click',function() {
    <%if (defined? open_new_tab) && open_new_tab%>
      window.open("/<%="#{@table_name}"%>/" + $(this).attr('record_id'), '_blank');
    <%else%>
      window.location = ("/<%="#{@table_name}"%>/"+$(this).attr('record_id'));
    <%end%>
  });


  $('#records_table').DataTable({
    dom: "<'row'<'col-xs-6'l><'col-sm-6'f>>" +
         "<'row'<'col-sm-12'tr>>" +
         "<'row'<'col-sm-5'i><'col-sm-7'p>>" +
         "<'row'<'col-sm-12'B>>",
    buttons: [
      'copy', 'csv', 'excel', 'print'
      //"pdf"//bug in pdf button for buttons 1.5.1 https://datatables.net/forums/discussion/46395/pdf-export-button-spinner-not-stopping
    ],
    "aLengthMenu": [[5, 10, 15, -1], [5, 10, 15, "All"]],
    "iDisplayLength": 10,
    "aaSorting": [[0, "desc"]],
    "columnDefs": [{ type: 'natural', targets: 0 }],
      initComplete: function(){
        this.api().columns().every(function(){
          var column = this;
          rand_num=new Date().getTime();
          var select = $('<input class=\'form-control\' list=\''+rand_num+'\'><datalist id=\''+rand_num+'\'><option value=""></option></datalist>')
              .appendTo( $(column.footer()).empty() )
              .on( 'keyup change input', function(){
                if( column.search() !== this.value ){
                  column.search( this.value ).draw();
                }
          });
          column.data().unique().sort().each(function(d, j){
            if(d != "" && d != undefined){
              $('#'+rand_num).append( '<option value="'+d+'">'+d+'</option>' );
            }
          });
        });
      },
  });
</script>
