<%= stylesheet_link_tag "/plugins/tables/datatables-1.10.16/datatables.min.css" %>
<%= javascript_include_tag "/plugins/tables/datatables-1.10.16/datatables.min.js" %>
<script type="text/javascript" src="//cdn.datatables.net/plug-ins/1.10.16/sorting/natural.js"></script>
<script type="text/javascript" src="/javascripts/utility/format-builder.js"></script>


<div class="col-xs-12">
  <%= render "shared/alerts"%>
  <%= render "access_controls/new_modal"%>
  <div class="panel panel-primary">
    <div class="panel-heading">
      <div class="panel-title">
        <div class="top_text">
          <b><%=@title%></b>
        </div>
        <div class="top_buttons pull-right">
          <%if defined?(btn_name)%>
            <%=link_to btn_name,
              btn_path,
              :class => "btn btn-success",
              :disable_with => "Redirecting..."%>
          <%end%>

          <%if @adv_only%>
            <%=link_to "Advanced Search",
              '#',
              :class => "btn btn-warning pull-right mr5",
              :id => "adv",
              "data-toggle" => "modal",
              "data-target" => ".bs-example-modal-lg"%>
            <%=link_to "Reset",
              request.path,
              :class => "btn btn-default pull-right mr5"%>
          <%end%>

        </div>
      </div>
    </div>

    <div class="panel-body">
      <div class="table-responsive">
        <table id="records_table" class="table table-hover table-striped table-bordered" width="100%">
          <thead>
            <tr>
              <%@headers.each do |header|%>
                <th><%=header[:title]%></th>
              <%end%>
              <th width="20%">Action</th>
            </tr>
          </thead>
          <tfoot>
            <tr>
              <%@headers.each do |header|%>
                <th><%=header[:title]%></th>
              <%end%>
              <th>Action</th>
            </tr>
          </tfoot>
          <tbody>
            <%@records.each do |record|%>
              <tr record_id="<%=record.id%>">
                <%@headers.each do |header|%>

                  <%field_name = header[:field]%>
                  <%field_value = record.send(field_name)%>
                  <%field_display = header[:display]%>
                  <%field_progress = header[:progress].present? ? record.send(header[:progress]) : '0%'%>

                  <%html_class = header[:html_class].present? ? record.send(header[:html_class]) : ''%>

                  <td class="<%=html_class%> percent" percentage="<%=field_progress%>">
                    <%case header[:type]%>
                    <%when "boolean"%>
                      <%boolean_options = {true => "Yes", false => "No"}%>
                      <%=boolean_options[field_value]%>
                    <%when "date"%>
                      <%=date_to_string(field_value)%>
                    <%when "datetime"%>
                      <%=datetime_to_string(field_value)%>
                    <%when "checkbox"%>
                      <%=field_value%>
                    <%when "user"%>
                      <%if field_value == "Anonymous"%>
                        Anonymous
                      <%elsif field_value != nil && field_value != ""%>
                        <%user = User.find(field_value)%>
                        <%if user.present?%>
                          <%=User.find(field_value).full_name%>
                        <%end%>
                      <%else%>
                        <%=""%>
                      <%end%>
                    <%when "textarea"%>
                      <%=(field_value.length > 50 ? "#{field_value[0..50]}..." : "#{field_value[0..50]}") rescue ''%>
                    <%when "list"%>
                      <%=field_value.gsub('<br>',', <br>')%>
                    <%when "select"%>
                      <%if field_display.present?%>
                        <%=field_display[field_value]%>
                      <%else%>
                        <%=field_value%>
                      <%end%>
                    <%else%>
                      <%=field_value%>
                    <%end%>
                  </td>
                <%end%>

                <td width="20%">
                  <%=link_to "Open",
                    "/#{@table_name}/#{record.id}",
                    :class => "btn btn-lightblue mr5 mb5",
                    :target => nil%>
                  <%=link_to "Open in New Tab",
                    "/#{@table_name}/#{record.id}",
                    :class => "btn btn-lightblue mr5 mb5",
                    :target => :_blank%>
                </td>


              </tr>
            <%end%>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<style>
  .datepicker{
    z-index: 1200!important;
  }
  tfoot {
    display: table-header-group;
  }
  .table tbody tr > td.red {
    background-color: orange !important;
  }
  .table tbody tr > td.yellow {
    background-color: yellow !important;
  }
  .table tbody tr > td.green {
    background-color: mediumseagreen !important;
  }
</style>



<script>

  $("td.percent").each(function() {
    var s = $(this).attr("percentage") + ' 100%';
    $(this).css({"background-size": s});
  });

  $('#records_table tbody tr td').on('click',function(){
    var cellIdx = $(this)[0].cellIndex;
    var lastIdx = $(this).closest("tr").find("td:last")[0].cellIndex;
    if(cellIdx != lastIdx){
      window.location = ("/<%="#{@table_name}"%>/" + $(this).closest("tr").attr('record_id'));
    }
  });


  $('#records_table').DataTable({
    dom: "<'row'<'col-xs-6'l><'col-sm-6'f>>" +
         "<'row'<'col-sm-12'tr>>" +
         "<'row'<'col-sm-5'i><'col-sm-7'p>>" +
         "<'row'<'col-sm-12'B>>",
    buttons: ['copy', 'csv', 'excel',
    {
      extend: 'print',
      exportOptions: {
        columns: [0, 1, 2, 3, 4, 5, 6, 7, 8]
      }
    }],
    "aLengthMenu": [[5, 10, 15, -1], [5, 10, 15, "All"]],
    "iDisplayLength": 10,
    "aaSorting": [[0, "desc"]],
    "columnDefs": [{ type: 'natural', targets: 0 }],
      initComplete: function(){
        this.api().columns().every(function(){
          var column = this;
          rand_num=new Date().getTime();
          var select = $('<input class=\'form-control\' list=\'' + rand_num + '\'><datalist id=\'' + rand_num + '\'><option value=""></option></datalist>')
              .appendTo( $(column.footer()).empty())
              .on( 'keyup change input', function(){
                if(column.search() !== this.value){
                  column.search(this.value).draw();
                }
          });
          column.data().unique().sort().each(function(d, j){
            if(d != "" && d != undefined){
              $('#' + rand_num).append( '<option value="' + d + '">' + d + '</option>' );
            }
          });
        });
      },
  });
</script>
