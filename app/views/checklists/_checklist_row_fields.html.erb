<% is_header = (defined? checklist_row) && checklist_row.is_header || false %>

<tr class='field_group to_delete <%= is_header ? 'header-row' : '' %>'>
  <%if ["address", "address_raw", "edit"].include? action_name%>
    <%=f.hidden_field :id, class: 'row-id changed'%>
  <%end%>

  <%if source == 'Existing'%>
    <%checklist_row.checklist_cells.each do |checklist_cell|%>
      <%cache("#{action_name}_checklist_cell_#{checklist_cell.id}") do%>
        <%=f.fields_for :checklist_cells, checklist_cell do |cell_form|%>
          <%header_item = checklist_cell.checklist_header_item%>
          <%=render 'checklist_row_fields_td',
            :source => source,
            :header_item => header_item,
            :checklist_cell => checklist_cell,
            :f => cell_form%>
        <%end%>
      <%end%>
    <%end%>
    <%unless action_name == 'edit' || action_name == 'retract_form_template'%>
      <td>
        <%unless is_header%>
          <%= render 'forms/attachments_show_mini', owner: checklist_row, edit: true, f: f %>
        <%end%>
      </td>
    <%end%>


  <%elsif source == 'Template'%>
    <%checklist_cells.each do |checklist_cell|%>
      <%new_checklist_cell = new_checklist_row.checklist_cells.build(checklist_cell.attributes)%>
      <%=f.fields_for :checklist_cells, new_checklist_cell do |cell_form|%>
        <%header_item = checklist_cell.checklist_header_item%>
        <%=render 'checklist_row_fields_td',
          :source => source,
          :header_item => header_item,
          :checklist_cell => checklist_cell,
          :f => cell_form%>
      <%end%>
    <%end%>


  <%else%>
    <%locals[:checklist_header].checklist_header_items.each do |header_item|%>
      <%checklist_cell = ChecklistCell.new%>
      <%=f.fields_for :checklist_cells, checklist_cell, { class: 'changed' } do |cell_form|%>
        <%=render 'checklist_row_fields_td',
          :header_item => header_item,
          :checklist_cell => checklist_cell,
          :f => cell_form%>
      <%end%>
    <%end%>
  <%end%>


  <%if action_name == 'edit' || action_name == 'retract_form_template'%>
    <td width="13%">
      <%=f.hidden_field :is_header, :id => 'is_header', :class => 'changed'%>
      <%=link_to "<i class='glyphicon glyphicon-header'></i>".html_safe, '#',
        :class => "btn #{is_header ? 'btn-success' : 'btn-default'} header_toggle_btn mt5"%>
      <%=f.hidden_field :_destroy, :id => "delete_row", :class => 'changed'%>
      <%=link_to "<i class='glyphicon glyphicon-trash'></i>".html_safe, '#', :class => "btn btn-danger remove_btn mt5"%>
    </td>
  <%end%>


</tr>

<script type="text/javascript">

  $(document).ready(function(){
    $('td').each(function(){
      $(this).find('.data_type_select').each(function(){
        if (['text', 'airport', 'employee', 'date', 'datetime', 'timezone'].includes($(this).find('option:selected').attr('value'))) {
          $(this).siblings('textarea').hide();
          $(this).siblings('.custom_options_select').hide();
        } else if (['dropdown-custom', 'radio-custom', 'checkboxes-custom'].includes($(this).find('option:selected').attr('value'))) {
            $(this).siblings('textarea').hide();
            $(this).siblings('.custom_options_select').show();
        } else {
          $(this).siblings('textarea').show();
          $(this).siblings('.custom_options_select').hide();
        }
      });
    });

    $('.header_toggle_btn').on('click', function(){
      var btn_state = $(this).attr("class").split(/\s+/);
      $(this).closest('td').siblings().each(function(){
        $(this).find('select').each(function(){
          if (btn_state.includes('btn-success')){
            $(this).show();
            if ($(this).find('option:selected').attr('value') == 'text') {
              $(this).siblings('textarea').hide();
            } else {
              $(this).siblings('textarea').show();
            }
          } else {
            $(this).hide();
            $(this).siblings('textarea').hide();
          }
        });
      });
    });

    $('.data_type_select').on("change", function(){
      if (['text', 'airport', 'employee', 'date', 'datetime', 'timezone'].includes($(this).find('option:selected').attr('value'))) {
        $(this).siblings('textarea').hide();
        $(this).siblings('.custom_options_select').hide();
        console.log($(this).siblings('.textarea').attr("id"))
        console.log($(this).siblings('.custom_options_select').attr("id"))
      } else if (['dropdown-custom', 'radio-custom', 'checkboxes-custom'].includes($(this).find('option:selected').attr('value'))) {
          $(this).siblings('textarea').hide();
          $(this).siblings('.custom_options_select').show();
          console.log($(this).siblings('.textarea').attr("id"))
          console.log($(this).siblings('.custom_options_select').attr("id"))
      } else {
        $(this).siblings('textarea').show();
        $(this).siblings('.custom_options_select').hide();
      }
    });
  })

</script>


