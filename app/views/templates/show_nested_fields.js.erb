swal.close();

swal({
  title: "<%=@field.label%>",
  html: "<%=escape_javascript render('/templates/show_nested_fields')%>",
  customClass: "custom-swal",
  showCancelButton: false,
  showConfirmButton: false,
  allowOutsideClick: false,
  onOpen: function(){

    if($("input[type='checkbox'][name='show_extra_info']").prop('checked')){
      $(".extra_info").show();
    }else{
      $(".extra_info").hide();
    }
    $(".deleted_fields").hide();

    // Archive/Unarchive button
    $(".archive_btn").on('click', function(e) {
      e.preventDefault();
      if ($(this).hasClass('btn-default')) { // Archived
        $(this).removeClass('btn-default').addClass('btn-warning');
        $(this).closest("td").find("#delete_field").val(false);
        $(this).closest('.to_delete').find(".form-control, .form-field-order").addClass('changed');
      } else { // Active
        $(this).removeClass('btn-warning').addClass('btn-default');
        $(this).closest("td").find("#delete_field").val(true);
        $(this).closest('.to_delete').find(".form-control, .form-field-order").addClass('changed');
      }
    });

    var fieldList = $(".draggableFieldGroup");
    fieldList.each(function(){
      $(this).sortable({
        handle: $(this, ".drag_and_drop"),
        forcePlaceholderSize: true,
        cursor: "move",
        animation: 100,
        start: function(event, ui){
          ui.placeholder.height(ui.item.height());
          ui.placeholder.width(ui.item.width());
        },
        update: function(event, ui){
          $('.field_group', this).each(function(index, elem) {
            $('.form-field-order', this).val(index);
            $('.form-field-order', this).addClass("changed");
            $('.form-control', this).addClass("changed");
          });
        }
      });
    });

    // Return a helper with preserved width of cells
    var fixHelper = function(e, ui) {
      ui.children().each(function() {
        $(this).width($(this).width());
      });
      return ui;
    };


    // var fieldList = $(".draggableFieldGroup");
    // fieldList.each(function(){
    //   $(this).sortable({
    //     helper: fixHelper,
    //     handle: $(this, ".drag_and_drop"),
    //     forcePlaceholderSize: true,
    //     cursor: "move",
    //     animation: 100,
    //     start: function(event, ui){
    //       ui.placeholder.height(ui.item.height());
    //       ui.placeholder.width(ui.item.width());
    //     },
    //     update: function(event, ui){
    //       $('.field_group', this).each(function(index, elem) {
    //         console.log(index);
    //         $('.form-field-order', this).val(index);
    //       });
    //     }
    //   });
    // });

  }
}).catch(swal.noop);


function removeField(deletable){
  $(deletable).closest('.to_delete').remove();
}


//function to add nested attributes
function add_fields(link, association, content, target) {
  var new_id = new Date().getTime();
  var regexp = new RegExp("new_" + association, "g")
  var insertposition="#"+target;
  $(content.replace(regexp, new_id)).appendTo($(link).closest(".panel-body").find(insertposition));
}


function closeSwal() {
  swal.close();
}
