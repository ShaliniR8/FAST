<script type="text/javascript" src="/javascripts/utility/nested_fields.js"></script>
<script type="text/javascript" src="/javascripts/utility/collapse-panel2.js"></script>
<script type="text/javascript" src="/javascripts/utility/validate-form.js"></script>
<script type="text/javascript" src="/javascripts/utility/delete.js"></script>
<script type="text/javascript" src="/javascripts/utility/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="/javascripts/utility/format-builder.js"></script>
<script type="text/javascript" src="/javascripts/utility/timezone-control.js"></script>
<script type="text/javascript" src="/javascripts/utility/extra_fields.js"></script>
<script type="text/javascript" src="/javascripts/utility/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/javascripts/utility/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="/javascripts/utility/dataTables.buttons.min.js"></script>
<link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap/dataTables.bootstrap.min.css"/>
<script type="text/javascript" src="/javascripts/utility/employee_select.js"></script>
<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>


<div class="item active" style="height:auto;">

  <%if @section.template.js_link.present?%>
    <script type="text/javascript" src="/javascripts/templates/<%=@section.template.js_link%>"></script>
  <%end%>


  <div class="panel panel-primary">



    <div class="modal fade bs-example-modal-lg emp_modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <%=render 'sections/emp'%>
        </div>
      </div>
    </div>

    <div class="modal fade bs-example-modal-lg airport_modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <%=render 'sections/airports_select'%>
        </div>
      </div>
    </div>

    <div class="panel-body" id="form_body">

      <%readonly = (@section.status == "Completed" || @section.status == "Approved")%>

      <%if readonly%>
        <%@section.categories.order(:category_order).each do |cat|%>
          <%=render "/sections/category",:category => cat, :section => @section%>
        <%end%>

      <%else%>
        <%=form_tag update_section_sras_path, method: :post, remote: true do %>
          <%=hidden_field_tag :section_id, @section.id%>
          <%=fields_for :sections, @section do |f|%>
            <div style="overflow-x:hidden;overflow-y:auto;height:100%" class="main-body">
              <div class="form-group">
                <div class="row" id="categories"></br>
                  <%@section.categories.where(deleted: false).order(:category_order).each do |c|%>
                    <%@cat=c%>
                    <%=render "/sections/category_fields", :f => f%>
                  <%end%>
                  <%@cat=nil%>
                </div>
              </div>
            </div>
          <%end%>
          <div class="form-actions mt20">
            <%if !readonly%>
              <%=submit_tag "Submit", :class => "btn btn-success pull-right mr20", :disable_with => "Submitting..."%>
              <%=submit_tag "Save", :class => "btn btn-warning pull-right mr5", :disable_with => "Saving..."%>
            <%end%>
          </div>
        <%end%>
      <%end%>


    </div>
  </div>

</div>



<style>
  .custom-swal {
    width: 70% !important;
    max-height: 100% !important;
    font-family: "Quattrocento Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 14px!important;
  }
  .swal2-modal .swal2-content {
    font-size: 14px;
    text-align: left;
}
</style>






<script type="text/javascript">

  var airport_table;

  $(document).ready(function(){
    // Get listing of all the airport buttons
    var field_id;
    $(this).find(".airport_button").each(function(index, item){
      // Get the button that's being clicked
      $(item).on("click", function(){
        // Get the selected airport's field id
        field_id = $(this).prop("id");
        resetModal(field_id);
        $("#search_btn").html('<button class="btn btn-info" id="search_btn_' + field_id + '">Search</button>');
        $("#search_btn_"+field_id).on("click", {field_id: field_id}, handleSearch);
      });
    });
  });

  // Updata airport table
  function handleSearch(event){
    // Get field id
    var field_id = event.data.field_id
    // Get the icao code user searched for
    var icao = $("#icao").val();
    var iata = $("#iata").val();
    var arpt_name = $("#arpt_name").val();
    // Do nothing if nothing is searched
    if(icao == "" && iata == "" && arpt_name ==""){
    // Update the table if icao code is not empty
    }else{
      // Get the data from server
      $.get('<%=airport_data_records_path%>?field_id=' + field_id + '&icao=' + icao + "&iata=" + iata + "&arpt_name=" + arpt_name, function(data){
        // Render airport table with data
        $("#airports_table").html(data);
        updateAirportTable(field_id);
      });
    }
  }

  function updateAirportTable(field_id){
    // Initialize table as a datatable
    airport_table = $('#airports' + field_id).DataTable({
      "aLengthMenu": [[5, 10, 15, -1], [5, 10, 15, "All"]],
      "iDisplayLength": 5
    });
    // User clicked on a row
    $("body").on("click", "#airports" + field_id + " tbody tr", function(){
      // Get the row information
      var icao = $(this).find("td").eq(0).text();
      var iata = $(this).find("td").eq(1).text();
      // Set the value on the form
      $("#airport" + field_id).val(icao + ";" + iata);
      $("#airport-select" + field_id).val(icao + ";" + iata);
      resetModal(field_id);
    });
  }

  function resetModal(field_id){
    // Reset the table, field, and close the modal
    $("#airports_table").html("");
    $("#icao").val("");
    $("#iata").val("");
    $("#arpt_name").val("");
    $('#airport_div').hide();
    $(".airport_modal").modal("hide");
  }
</script>
