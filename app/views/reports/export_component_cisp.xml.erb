<%record = reports.first.records.includes(:template).first%>
<%pCode = CONFIG::P_CODE[record.template.name] %>
<%airlineId = CONFIG::AIRLINE_ID[record.template.name] %>

<?xml version="1.0" encoding="iso-8859-1"?>
<cispReports xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="cisp-data-exchange-schema.xsd" airlineId="<%=airlineId%>" pCode="<%=pCode%>">

  <%reports.each_with_index do |report, index|%>
    <%# only include records that are ASAP%>
    <%records = report.records.includes(:template).select { |rec| CONFIG::CISP_TITLE_PARSE[rec.template.name] }%>
    <%# use CISP info from only the first report%>
    <%record = records.first%>
    <%event_id = report.id%>

    <%puts "#{index+1}: Report##{report.id}"%>

    <%if record.event_date.nil?%>
      <%puts "#{index+1}: Report##{record.id} - event date is missing"%>
      <%next%>
    <%end%>

  <cispReport eventId="<%=report.id%>">
    <reportSourceType>
      <%=CONFIG::CISP_TITLE_PARSE[record.template.name]%>
    </reportSourceType>
    <synopsis><%="#{report.name} Event ##{event_id}"%></synopsis>

    <%timezone = record.get_cisp_timezone%>
    <%timezone_value = timezone.values[0]%>
    <flightDateTime zone="<%=timezone.keys[0]%>">
      <date><%=record.event_date.in_time_zone(timezone_value).strftime("%F")%></date>
      <hour><%=record.event_date.in_time_zone(timezone_value).strftime("%H")%></hour>
      <minute><%=record.event_date.in_time_zone(timezone_value).strftime("%M")%></minute>
    </flightDateTime>

    <%all_record_fields = record.record_fields.map{|rf| [rf.fields_id, rf]}.to_h%>
    <%CONFIG::CISP_FIELD_PARSE[record.template.name].each do |category_name, fields|%>
      <%category = record.categories.select { |category| category.title == category_name}.first%>
      <%if category.present?%>

        <%category.fields.select{ |field| field.deleted == false }.each do |field|%>
          <%if all_record_fields[field.id].nil?%>
            <%puts "field ##{field.id} is empty"%>
            <%next%>
          <%end%>

          <%tag_name    = fields.invert[field.label]%>

          <%field_value = all_record_fields[field.id].value%>

          <%# narrative is handled separately%>
          <%next if tag_name == 'eventDescription'%>

          <%# add station code and other location to location field%>
          <%if tag_name == 'location' && AIRLINE_CODE != "RJET"%>
            <%station_code_field = category.fields.select { |f| f.label.include? "Station Code"}.first%>
            <%other_location_field = category.fields.select { |f| f.label.include? "Specify Other Location"}.first%>
            <%station_code = all_record_fields[station_code_field.id].value rescue ''%>
            <%other_location = all_record_fields[other_location_field.id].value rescue ''%>
            <%loc = ""%>
            <%separator = ''%>
            <%if field_value.present? || other_location.present?%>
              <%loc = "Location: "%>
              <%loc = loc + (field_value.present? ? field_value : other_location)%>
              <%separator = ', '%>
            <%end%>
            <%location = loc + separator + "Station Code: #{station_code}" if station_code.present?%>
            <%field_value = location%>
          <%end%>

  <%if field_value.present? && tag_name.present?%>
    <%=raw "<#{tag_name}>"+ field_value.gsub("\r\n", ' ').gsub("\n\n", ' ') +"</#{tag_name}>"%>
  <%end%>

        <%end%>
      <%end%>
    <%end%>

    <%# narratives are included from each report%>
    <%narratives = "".html_safe%>
    <%records.each do |record|%>
      <%all_record_fields = record.record_fields.map{|rf| [rf.fields_id, rf]}.to_h%>
      <%# narrative and duty fields are obtained by panel title and field label%>
      <%# separate narrative by Record ID - Submitter Title%>

      <%if AIRLINE_CODE == "RJET"%>
        <%narrative_category_name = CONFIG::CISP_FIELD_PARSE[record.template.name].keys.select { |category_name| ["Narrative", "Description"].any? { |word| category_name.include? word } }.first%>

        <%narrative_label_name = CONFIG::CISP_FIELD_PARSE[record.template.name][narrative_category_name]["eventDescription"]%>

        <%narrative_field = record.categories.select { |category| category.title == narrative_category_name}.first.fields.select { |f| f.label.include? narrative_label_name }.first rescue byebug %>

        <%narrative = all_record_fields[narrative_field.id].value rescue ''%>

        <%narratives = narratives + "Record ID #{record.id} " + "<br/>".html_safe + narrative + "<br/><br/>".html_safe%>
      <%else%>
        <%narrative_field = record.categories.select { |category| category.title == 'Narratives'}.first.fields.select { |f| f.label.include? "Please provide a narrative about the event" }.first%>
        <%overview_category_fields = record.categories.select { |category| category.title == 'Overview'}.first.fields%>
        <%primary_duty_field = overview_category_fields.select { |f| f.label.include? "Primary Duties at the Time of Event" }.first%>
        <%other_duty_field = overview_category_fields.select { |f| f.label.include? "Specify Other Primary Duties" }.first%>
        <%narrative = all_record_fields[narrative_field.id].value rescue ''%>
        <%duty = all_record_fields[primary_duty_field.id].value rescue ''%>
        <%other_duty = all_record_fields[other_duty_field.id].value rescue ''%>
        <%if narrative.present?%>
          <%narratives = narratives + "Record ID #{record.id} " + (duty.present? ? "- #{duty} " : '') + "#{other_duty.present? ? "and #{other_duty}" : ''}" + "<br/>".html_safe + narrative + "<br/><br/>".html_safe%>
        <%end%>
      <%end%>
    <%end%>
    <eventDescription>
      <%=narratives%>
    </eventDescription>

  <%root_causes = report.occurrences%>
  <%if root_causes.present?%>
    <contributingCause>
    <%root_causes.each do |root_cause|%>
      <cause>
        <%=root_cause.value.gsub(/[\r\n]+/, ', ')%>
      </cause>
    <%end%>
    </contributingCause>
  <%end%>

  <%if test_run%>
    <comment><%="Testing #{AIRLINE_CODE} Event Uploading"%></comment>
  <%else%>
    <%# final comment%>
    <comment><%=report.narrative.gsub(/[\r\n]+/, '')%></comment>
  <%end%>

  </cispReport>
  <%end%>
</cispReports>
