<script type="text/javascript" src="/javascripts/messages/recipients-control.js"></script>
<script type="text/javascript" src="/javascripts/utility/format-builder.js"></script>
<script type="text/javascript" src="/javascripts/utility/extra_fields.js"></script>

<div class="panel-warning">
  <div class="panel-heading">
    <div class="panel-title">
      <%=@reply_to.present? ? "Re: "+@reply_to.subject : "New Message" %>
      <button type="button"
        class="close pull-right"
        data-dismiss="modal"
        aria-label="Close">
        <span class="glyphicon glyphicon-remove"></span>
      </button>
    </div>
  </div>

  <div class="panel-body" style="max-height:calc(100vh - 210px);overflow-y:auto">
    <div class="row">
      <div class="col-xs-12">
        <%=form_for @message, remote: true, :html => {:multipart => true}, :class => "form-horizontal" do |f|%>
          <%if @reply_to.present?%>
            <%=hidden_field_tag :reply_to, @reply_to.id%>
          <%end%>
          <div class="col-xs-5">
            <%=render "/messages/recipients"%>
          </div>

          <div class="col-xs-7">
            <%=f.hidden_field :link, :value => params[:link]%>
            <%=f.hidden_field :link_type, :value => params[:link_type]%>
            <%=f.hidden_field :link_id, :value => params[:link_id]%>

            <div class="col-xs-12">
              <%=f.label :subject, "Subject", :class => "control-label col-xs-2"%>
              <div class="col-xs-10">
                <%=f.text_field :subject,
                  {:class => "form-control",
                  :value => @reply_to.present? ? "Re: " + @reply_to.subject : ""}%>
              </div>
            </div>

            <div class="col-xs-12 mt10">
              <%=label_tag "template",
                "Template",
                :class => "control-label col-xs-2"%>
              <div class="col-xs-6">
                <%= select_tag "template",
                  options_for_select(CannedMessage.all.collect{|p| [p["name"], p["id"]]}),
                  {:include_blank => true,
                  :class => "form-control template"}%>
              </div>
            </div>

            <div class='col-xs-12 mt5'>
              <%=label_tag "template", "Attached", :class => "control-label col-xs-2"%>
              <div class="col-xs-6">
                <b>
                  <%if params[:link_type]%>
                    <%=link_to "#{params[:link_type].titleize} ##{params[:link_id]}", "#{params[:link]}"%>
                  <%else%>
                    N/A
                  <%end%>
                </b>
              </div>
            </div>


            <div class="col-xs-12 mt5">
              <div class="col-xs-12 mt10">
                <%=f.text_area :content,
                  {:class => "form-control",
                  :rows => "15",
                  :id => "content"}%>
              </div>
            </div>

            <div class="col-xs-12 mt5">
              <div class="col-xs-11 row" id="attachments"></div>
              <div class="col-xs-12">
                <%= link_to_add_fields "Add an attachment", f, :attachments%>
              </div>
            </div>
          </div>


          <%=f.hidden_field :time, :value => Time.now.utc%>
          <div class="row mt5">
            <div class="col-sm-12 pull-right">
              <%=f.submit "Send",
                :class => "btn btn-success pull-right",
                :disable_with => "Sending..."%>
              <%=link_to "Cancel",
                params[:link] || root_url,
                :confirm => 'Are you sure?',
                :disable_with => 'Redirecting...',
                :class => "btn btn-default pull-right mr5"%>
            </div>
          </div>
        <%end%>
      </div>
    </div>
  </div>

</div>


<script type="text/javascript">
  $(document).ready(function(){
    $(".template").on("change", function(){
      var message_template_id = $(this).val();
      $.get("<%=canned_messages_path%>/"+message_template_id, function(data){
        $("#content").val(data.data.content);
      });
    });

  });
</script>
