<%= javascript_include_tag(
  'utility/collapse-panel2',
  'utility/jquery.dataTables.min',
  'utility/dataTables.bootstrap.min.js',
  'utility/dataTables.buttons.min.js',
  )
%>
<link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap/dataTables.bootstrap.min.css"/>

<%=render "access_controls/new_modal"%>
<div class="item active mt50" style="height:auto;">
  <div class="grid per90 center-block">
    <%= render "shared/alerts" %>
    <div class="col-xs-12">
      <div class="panel panel-primary">
        <div class="panel-heading">
          <div class="panel-title">
            <div class="top_text">
              <%="Finding ##{@owner.get_id}: #{@owner.title}"%>
            </div>
            <div class="top_buttons pull-right">
              <%= render '/forms/render_buttons', owner: @owner, true_owner: @true_owner, env: :top %>
            </div>
          </div>
        </div>

        <div class="panel-body">
          <% if CONFIG::GENERAL[:display_workflow_diagram] %>
            <div class="col-xs-12">
              <%instruction = "<p>"
                instruction = instruction + "<button id ='toggleWorkflowImageButton' type='button' class='btn btn-light' >Show Workflow Image</button>"
                instruction = instruction + "</p>"
                instruction = instruction + "<img id='workflowImage' class = 'workflowImg' height=800 width= 100%/>"
              %>
              <%=render "shared/instructions",
                :instruction => instruction%>
            </div>
          <% end %>
          <div class="col-xs-12 mb20">

            <%= render 'forms/render_buttons', owner: @owner, env: :inline %>

            <%if @owner.owner.class.name != 'ChecklistRow' && @owner.status == 'New' && !@owner.can_assign?(current_user) && CONFIG::GENERAL[:has_source_of_input_msg]%>
              <b style='color:red;'>*Please complete the <%=link_to "Source of Input", @owner.owner %> before assigning the Finding.</b>
            <%end%>

          </div>

          <%= render '/forms/show_fields', :fields => @fields, :record => @owner %>

          <% can_change = @owner.status != "Completed" &&
             @owner.status != "Pending Approval" &&
             current_user.has_access("findings","edit")%>

          <%= render 'risk_matrices/panel_matrix/risk_assessment_panel', risk_type: 'All'%>
          <%= render '/panels/show_panels', owner: @owner %>

        </div>
      </div>
    </div>
  </div>
</div>




<style>
  .datepicker{
    z-index: 1200!important;
  }
   #workflowImage{
    display: none;
  }
</style>




<script>
  $(document).ready(function(){

    <% if CONFIG::GENERAL[:display_workflow_diagram] %>
      <% status_field_name = CONFIG.sa::HIERARCHY[:objects][@owner.class.name][:fields][:status][:field]%>
      <% curr_status = @owner.send(status_field_name).downcase %>
      $("#workflowImage").attr('src', "<%=CONFIG.sa::HIERARCHY[:objects][@owner.class.name][:workflow_images].select {|key| curr_status.include? key}.values[0]%>")
    <% end %>

     $("#toggleWorkflowImageButton").on('click', function(event){
        event.preventDefault();
    
        if($("#workflowImage").is(":visible")){
          $("#workflowImage").delay(1).hide("slow")
          $("#toggleWorkflowImageButton").html("Show Workflow Image")
        }else{
          $("#workflowImage").delay(1).show("slow")
          $("#toggleWorkflowImageButton").html("Hide Workflow Image")
        }
      })

    $('#att_btn').on('click',function(){
      $.get("<%=new_attachment_finding_path(@owner)%>",function(data){
        $(".modal-content").html(data);
        $(window).trigger('resize');
      });
    });
  });
</script>
