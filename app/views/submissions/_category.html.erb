<%deid = defined?(deid) ? deid : false%>
<%if @cat.print || !deid%>
  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="panel <%=@cat.panel%>">
      <div class="panel-heading click-heading collapsed">
        <div class="panel-title">
          <b><%=@cat.title%></b>
          <span class="pull-right clickable">
            <i class="mt5 glyphicon glyphicon-chevron-down"></i>
          </span>
        </div>
      </div>
      <div class="panel-body" style="display:none">
        <div class="row" id="fields" style="word-wrap: break-word">
          <%all_submission_fields = @record.submission_fields.map{|sf| [sf.fields_id, sf]}.to_h%>
          <%@cat.fields.each do |field|%>
            <%if field.print || !deid%>
              <%if field.nested_field_id.nil?%>
                <%sub_field = all_submission_fields[field.id]%>

                <%=render "display_field", field: field, sub_field: sub_field, deid: deid%>

                <!-- Nested fields -->
                <%if (field.nested_fields.where(deleted: false).length > 0 rescue false)%>
                  <div class="col-xs-12 mb20">
                    <div class="col-xs-12 graybox">
                      <%field.nested_fields.where(deleted: false).each do |nest_field|%>
                        <%if sub_field.present? && sub_field.value.present? && nest_field.nested_field_value.present? &&
                                      ((sub_field.value.parameterize == nest_field.nested_field_value.parameterize) ||
                                      (sub_field.value.include?(";") && sub_field.value.include?(nest_field.nested_field_value)))%>
                          <%sn_field = all_submission_fields[nest_field.id]%>
                          <%=render "display_field", field: nest_field, sub_field: sn_field, deid: deid%>
                        <%end%>
                      <%end%>
                    </div>
                  </div>
                <%end%>

              <%end%>
            <%end%>
          <%end%>
        </div>
      </div>
    </div>
  </div>
<%end%>


<style>
  .smallselect {
    position: relative;
    top: 50%;
    transform: translateY(-50%);
  }
  .graybox {
    padding: 15px 0;
    background-color: rgb(211,211,211, 0.15);
    border-radius: 5px;
  }
</style>
