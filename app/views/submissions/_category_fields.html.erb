<div class="col-sm-12 col-md-12 col-lg-12">
  <div class="panel <%=@cat.panel%> category-panel">
    <div class="panel-heading click-heading collapsed">
      <div class="panel-title">
        <%=@cat.title%>
        <span class="pull-right clickable">
          <i class="mt5 glyphicon glyphicon-chevron-down"></i>
        </span>
      </div>
    </div>
    <div class="panel-body" style="display:none">

      <div class="row" id="fields">
        <div class="col-xs-12">
          <font style="color:blue;font-weight:bold"><%=@cat.description%></font>
        </div>
        <div class="col-xs-12">
          <%fields = @cat.fields.where(deleted: false, nested_field_id: nil).order(:field_order)%>
          <%category_fields_by_rows = group_by_column_size_and_nested_fields(fields: fields)%>

          <%category_fields_by_rows.each do |row| %>
            <div class="row is-flex">
              <%row.each do |field| %>

                <%=render "/submissions/field", is_nested_field: false, field: field, f: f%>

                <%if field.nested_fields.where(deleted: false).present?%>
                  <%field.nested_fields.where(deleted: false).order(:field_order).group_by(&:nested_field_value).each do |nv, nested_fields|%>

                    <div class="col-xs-12 nested_field_area">
                      <h4 class="nested_field_header" style="display:none"><span><b><%=nv%></b></span></h4>

                      <%nested_fields_by_rows = group_by_column_size_and_nested_fields(fields: nested_fields)%>
                      <%nested_fields_by_rows.each do |nested_field_row|%>

                        <div class="col-xs-12 nested_field_row" style="display:none;">

                          <%nested_field_row.each do |nested_field|%>

                            <%size = calculate_column_size(field: nested_field)%>
                            <%if @record.present?%>
                              <%record_field = @record.submission_fields.where("fields_id = ?", field.id).first%>
                              <%if record_field.present? && record_field.value.present?%>

                                <%if (record_field.value.parameterize == nested_field.nested_field_value.parameterize) ||
                                     (record_field.value.include?(';') && record_field.value.include?(nested_field.nested_field_value))%>
                                   <div class="<%=size%> nested_field
                                      nested_field_<%=field.id%>
                                      nested_field_<%=field.id%>_<%=nested_field.nested_field_value.parameterize%>">
                                      <%=render "/submissions/field", is_nested_field: true, field: nested_field, f: f%>
                                    </div>

                                <%else%>
                                  <div class="<%=size%> nested_field
                                    nested_field_<%=field.id%>
                                    nested_field_<%=field.id%>_<%=nested_field.nested_field_value.parameterize%>"
                                    style="display:none;">
                                    <%=render "/submissions/field", is_nested_field: true, field: nested_field, f: f%>
                                  </div>
                                <%end%>

                              <%else%>
                                <div class="<%=size%> nested_field
                                  nested_field_<%=field.id%>
                                  nested_field_<%=field.id%>_<%=nested_field.nested_field_value.parameterize%>"
                                  style="display:none;">
                                  <%=render "/submissions/field", is_nested_field: true, field: nested_field, f: f%>
                                </div>
                              <%end%>

                            <%else%>
                              <div class="<%=size%> nested_field
                                nested_field_<%=field.id%>
                                nested_field_<%=field.id%>_<%=nested_field.nested_field_value.parameterize%>"
                                style="display:none;">
                                <%=render "/submissions/field", is_nested_field: true, field: nested_field, f: f%>
                              </div>
                            <%end%>
                          <%end%>

                        </div>

                      <%end%>
                    </div>
                  <%end%>
                <%end%>

              <%end%>
            </div>
            <hr>
          <%end%>
        </div>
      </div>
    </div>
  </div>
</div>


<style>
  #fields {
    margin: 0 15px;
  }

  .row.is-flex {
    display: flex;
    flex-wrap: wrap;
  }
  .row.is-flex > .nested_field_row > .nested_field > .form-group {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
  .row.is-flex > [class*='col-'] {
    display: flex;
    flex-direction: column;
    justify-content: flex-start !important;
  }

  .row.is-flex > .nested_field_row {
    flex-direction: row;
    justify-content: flex-start !important;
  }

  .graybox {
    padding: 15px 0;
    background-color: rgb(211,211,211, 0.15);
    border-radius: 5px;
  }

  h4 {
    color: ;
    width: 100%;
    text-align: center;
    border-bottom: 1px solid silver;
    line-height: 0.1em;
    margin: 10px 0 20px;
    color: grey;
  }

  h4 span {
    background:#fff;
    padding:0 10px;
  }
</style>



<script>

  $(document).ready(function(){

    $(".field_select").each(function(){
      update_nested_fields($(this));
    });

    $(".field_cb_select").each( function(){
      update_cb_rb_nested($(this), false);
    });

    $(".field_rb_select").each(function(){
      update_cb_rb_nested($(this), false);
    });


    $(".field_select").on("change", function(){
      update_nested_fields($(this));
      update_panel_titles($(this));
    });


    $(".required_field").css('border-color', '');
    $(".required_field").closest('.form-group').find('label').not('.checkbox').not('.radio').css("color", "red");


    $(".field_cb_select").on("change", function(){
      update_cb_rb_nested($(this), false);
      update_panel_titles($(this));
    });


    $(".field_rb_select").on("change", function(){
      update_cb_rb_nested($(this), true);
      update_panel_titles($(this));
    });
  });


  function update_panel_titles(target){
    var count = 0;
    $(target).closest('div.category-panel').find('.required_field').each(function(){
      if ($(this).is(':visible')) {
        count++;
      }
    });
    if (count > 0) {
      $(target).closest('div.category-panel').find('.panel-title').css("color", "red");
      $(target).closest('div.category-panel').find('.panel-title').value = "*" ;
    } else {
      $(target).closest('div.category-panel').find('.panel-title').css("color", "");
      $(target).closest('div.category-panel').find('.panel-title').value = "" ;
    }
  }


</script>
