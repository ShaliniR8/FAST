<div class = 'wrap'>
  <div class="title">
    Submission <%="##{owner.get_id}: #{owner.template.name} #{(CONFIG.sr::GENERAL[:show_title_deid_pdf].present? || !deidentified.present?) ? "- #{owner.get_description}" : ""}"%> <b style="color:darkred; font-size:18px"><%=owner.confidential? ? "(This Submission is CONFIDENTIAL)" : ''%></b>
  </div>

  <div class="content">

    <%=render "/pdfs/print_fields",
      :fields => Submission.get_meta_fields(*@meta_field_args),
      :owner => owner,
      :deidentified => deidentified%>

    <%=render '/pdfs/print_notes', owner: owner%>

    <div class="col-xs-12">
      <div class="col-xs-12">
        <hr>
      </div>

      <%owner.template.categories.order(:category_order).each do |cat|%>

        <%if cat.id == 338%>
          <div class="category">
            <div class="sub_sub_title"><%=cat.title%></div>
            <table id="observation_phases_table" class="table table-bordered" width="100%">
              <thead>
                <tr>
                  <%CONFIG.sr::OBSERVATION_PHASES.each do |x|%>
                    <th><%=x%></th>
                  <%end%>
                </tr>
              </thead>
              <tbody>
                <%cat.fields.group_by(&:element_id).each do |element_id, arr|%>
                  <%if owner.submission_fields.where(:fields_id => arr.first.id).present? &&
                    owner.submission_fields.where(:fields_id => arr.first.id).first.value.present?%>
                    <tr>
                      <th><%=arr.first.label%></th>
                      <%arr.each do |x|%>
                        <%submission_fields = owner.submission_fields.where(:fields_id => x.id).first%>
                        <td><%=submission_fields.value%></td>
                      <%end%>
                    </tr>
                  <%end%>
                <%end%>
              </tbody>
            </table>
          </div>

        <%elsif cat.not_empty_for(owner) && (cat.print || !deidentified)%>
          <div class="content">
            <div class="sub_sub_title"><%=cat.title%></div>
            <%cat_fields_processed = []%>
            <%cat.fields.order(:field_order).each do |field|%>

              <%if cat_fields_processed.exclude?(field.id) && field.nested_field_id.nil?%>
                <%if field.print || !deidentified%>
                  <%value = owner.submission_fields.where("fields_id = ?", field.id).first%>
                  <%valueCopy = value%>
                  <%if value.present?%>
                    <%value = value.print_value%>
                    <%if value.present?%>
                      <%if cat.title == "Narratives" %>
                        <b><%=field.label.present? ? (field.label + ":") : ""%></br> </b><%=value.gsub(/\n/, '<br/>').html_safe%></br>
                      <%else%>
                        <b><%=field.label.present? ? (field.label + ":") : ""%></b>
                        <%if field.display_type == "employee"%>
                          <%if value.match(/\A[+-]?\d+?(\.\d+)?\Z/)%>
                            <%if CONFIG::GENERAL[:sabre_integration].present? && AIRLINE_CODE == 'RJET'%>
                              <%#=User.where(employee_number: value).first.full_name rescue nil%>
                              <%#=value%>
                              <%if value.present?%>
                                <%user_name = User.where(employee_number: value).first.full_name rescue nil%>
                                <%value = "(#{value})"%>
                                <%if user_name.present?%>
                                  <%value = user_name + " #{value}" %>
                                <%end%>
                                <%=value%>
                              <%end%>
                            <%else%>
                              <%=User.find(value).full_name%>
                            <%end%>
                          <%else%>
                            <%=value%>
                          <%end%>
                        <%elsif field.display_type == "map"%>
                          <%if valueCopy.points.present?%>
                            <%=render :partial => 'shared/static_map', locals: {points: valueCopy.points}%>
                          <%end%>

                        <%else%>
                          <%if field.display_type == "employee"%>
                            <%if value.match(/\A[+-]?\d+?(\.\d+)?\Z/)%>
                              <%=User.find(value).full_name%>
                            <%else%>
                              <%=value%>
                            <%end%>
                          <%else%>
                            <%if field.data_type == "datetime"%>
                              <%=datetime_to_string(DateTime.parse value) rescue ''%>
                            <%else%>
                              <%=value%>
                            <%end%>
                          <%end%>
                          </br>
                        <%end%>
                        </br>
                      <%end%>
                    <%end%>
                  <%end%>
                  <%nested_fields = cat.fields.where("nested_field_id=?", field.id)%>
                  <%if nested_fields.present?%>
                    <%nested_fields.each do |nested_field|%>
                      <%cat_fields_processed << nested_field.id%>
                      <%rec_field = owner.submission_fields.where("fields_id = ?", nested_field.id).first%>
                      <%if rec_field.present? && rec_field.value.present?%>
                        <%value = rec_field.print_value%>
                        <%if rec_field.present? && rec_field.value.present?%>
                          <%if (nested_field.nested_field_value.strip == rec_field.value.strip) ||
                               (field.options.include?(";") && field.options.include?(nested_field.nested_field_value.strip))%>
                            <div class="nested_field" style="margin-left:15px;">
                              <%if cat.title == "Narratives" %>
                                <b><%=nested_field.label.present? ? (nested_field.label + ":") : ""%></br> </b><%=value.gsub(/\n/, '<br/>').html_safe%></br>
                              <%else%>
                                <b><%=nested_field.label.present? ? (nested_field.label + ":") : ""%></b>
                                <%if nested_field.display_type == "employee"%>
                                  <%if value.match(/\A[+-]?\d+?(\.\d+)?\Z/)%>
                                    <%if CONFIG::GENERAL[:sabre_integration].present? && AIRLINE_CODE == 'RJET'%>
                                      <%#=User.where(employee_number: value).first.full_name rescue nil%>
                                      <%#=value%>
                                      <%if value.present?%>
                                        <%user_name = User.where(employee_number: value).first.full_name rescue nil%>
                                        <%value = "(#{value})"%>
                                        <%if user_name.present?%>
                                          <%value = user_name + " #{value}" %>
                                        <%end%>
                                        <%=value%>
                                      <%end%>
                                    <%else%>
                                      <%=User.find(value).full_name%>
                                    <%end%>
                                  <%else%>
                                    <%=value%>
                                  <%end%>
                                <%else%>
                                  <%if nested_field.display_type == "employee"%>
                                    <%if value.match(/\A[+-]?\d+?(\.\d+)?\Z/)%>
                                      <%=User.find(value).full_name%>
                                    <%else%>
                                      <%=value%>
                                    <%end%>
                                  <%else%>
                                    <%if nested_field.data_type == "datetime"%>
                                      <%=datetime_to_string(DateTime.parse value) rescue ''%>
                                    <%else%>
                                      <%=value%>
                                    <%end%>
                                  <%end%>
                                  </br>
                                <%end%>
                              <%end%>
                            </div>
                            </br>
                          <%end%>
                        <%end%>
                      <%end%>
                    <%end%>
                  <%end%>
                <%end%>
              <%end%>
            <%end%>
          </div>
        <%end%>

      <%end%>
    </div>

    <% if CONFIG::GENERAL[:add_attachment_in_pdf] %>
      <%= render '/pdfs/print_attachments', owner: owner%>
    <%end%>

  </div>
</div>
<!-- sub_field.value.include?(nest_field.nested_field_value) -->
